name: Assign Labels from Linked Issues

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  assign_labels:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Check linked issues
        id: check_linked_issues
        uses: nearform-actions/github-action-check-linked-issues@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Assign labels
        if: steps.check_linked_issues.outputs.linked_issues != ''
        run: |
          echo "Linked issues: ${{ steps.check_linked_issues.outputs.linked_issues }}"
          issues=$(echo "${{ steps.check_linked_issues.outputs.linked_issues }}" | sed -e 's/\s/,/g')
          echo "Issues with labels: $issues"
          echo "Pull request number: ${{ github.event.pull_request.number }}"
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${issues}/labels" \
            -d "{\"labels\":$(curl -H \"Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}\" -H \"Accept: application/vnd.github.v3+json\" https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/labels | jq -r '.[].name' | sed -e 's/\"/\\\"/g' -e 's/.*/\"&\"/g' | paste -sd,) }"
